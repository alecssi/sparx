<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SPARX — Smart Parking SPA (Large UI)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-sA+q0k6k9Qv8g1kRkXy0v6vV6mZb3nK0bP+qkPQf0u8="
  crossorigin=""/>
<style>
  :root{
    --scale:1.25; /* large UI */
    --font-base:18px;
    --bg:#FF0000; /* changed to red background */
    --muted:#5f6b70;
    --accent:#FF0000; /* accent red */
    --accent-700:#cc0000;
    --card:#ffffff;
    --radius:14px;
    --shadow-sm: 0 8px 24px rgba(12,18,30,0.06);
    --shadow-lg: 0 22px 48px rgba(12,18,30,0.09);
    font-family: 'Inter', system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }

  html,body{height:100%;margin:0;background:linear-gradient(180deg,#ff4d4d 0%, #FF0000 100%);color:#071022;-webkit-font-smoothing:antialiased;font-size:var(--font-base)}
  .app{max-width:1220px;margin:20px auto;padding:20px;min-height:calc(100vh - 40px);display:flex;flex-direction:column;gap:18px}

  /* top bar */
  .topbar{display:flex;align-items:center;gap:14px;padding:16px;border-radius:14px;background:linear-gradient(90deg,var(--accent),var(--accent-700));color:white;box-shadow:var(--shadow-sm)}
  .brand{display:flex;align-items:center;gap:14px}
  .brand .logo{width:60px;height:60px;border-radius:12px;background:rgba(255,255,255,0.16);display:flex;align-items:center;justify-content:center}
  .brand .title{font-weight:800;text-transform:lowercase;font-size:20px}
  .brand-sub{font-size:13px;color:rgba(255,255,255,0.9)}
  .topbar .spacer{flex:1}
  .topbar button{background:transparent;border:0;color:white;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
  .topbar .btn-ghost{background:rgba(255,255,255,0.12)}
  .clock{font-weight:700;font-size:18px;opacity:0.95}

  /* layout */
  .screens{display:grid;grid-template-columns:1fr;gap:18px;align-items:start}
  @media(min-width:1000px){ .screens{grid-template-columns:1fr 420px;} }

  /* card / list */
  .panel{background:var(--card);border-radius:14px;padding:18px;box-shadow:var(--shadow-sm)}
  .searchbar{display:flex;gap:12px;align-items:center}
  .searchbar input{flex:1;padding:14px;border-radius:12px;border:1px solid #e6eff4;font-size:16px}
  .searchbar .btn-search{padding:12px 14px;border-radius:12px;border:0;background:var(--accent);color:white;cursor:pointer;font-weight:700}
  .spots-grid{display:grid;gap:14px;margin-top:14px}
  @media(min-width:700px){ .spots-grid{grid-template-columns:repeat(2,1fr);} }
  @media(min-width:1100px){ .spots-grid{grid-template-columns:repeat(3,1fr);} }

  .spot{display:flex;gap:14px;align-items:center;padding:16px;border-radius:12px;border:1px solid rgba(7,16,34,0.04);cursor:pointer;background:linear-gradient(180deg, #fff, #fbfdff);transition:transform .12s, box-shadow .12s}
  .spot:hover{transform:translateY(-6px);box-shadow:var(--shadow-lg)}
  .spot .icon{width:80px;height:80px;border-radius:12px;background:linear-gradient(180deg,#fff5f5,#ffffff);display:flex;align-items:center;justify-content:center;flex-shrink:0;border:1px solid rgba(255,0,0,0.06)}
  .spot h4{margin:0;font-size:18px}
  .spot p{margin:6px 0 0;font-size:15px;color:var(--muted)}
  .spot .meta{flex:1}
  .spot .status{font-weight:800;padding:8px 12px;border-radius:12px;font-size:14px}

  .status-available{background:linear-gradient(180deg,#fff6f6,#ffffff);color:#b00000;border:1px solid rgba(176,0,0,0.08)}
  .status-reserved{background:linear-gradient(180deg,#fff6f6,#fff);color:#d44b4b;border:1px solid rgba(212,75,75,0.08)}

  /* favorite star */
  .fav-btn{background:transparent;border:0;cursor:pointer;font-size:20px;color:#d0d0d0;padding:6px;border-radius:8px}
  .fav-btn.active{color:#ffbf00}

  /* right column (preview / account) */
  .preview{display:flex;flex-direction:column;gap:14px}
  .card-compact{background:var(--card);padding:16px;border-radius:12px;box-shadow:var(--shadow-sm)}
  .account{display:flex;gap:12px;align-items:center}
  .account .avatar{width:64px;height:64px;border-radius:12px;background:linear-gradient(180deg,#fff0f0,#fff);display:flex;align-items:center;justify-content:center;border:1px solid rgba(7,16,34,0.04)}
  .account .name{font-weight:800;font-size:16px}
  .small-muted{font-size:14px;color:var(--muted)}

  /* map */
  #map { width: 100%; height: 260px; border-radius:12px; border:1px solid rgba(7,16,34,0.04); margin-top:12px }

  /* screens */
  .screen{display:none}
  .screen.active{display:block}

  /* forms */
  .form-row{display:flex;flex-direction:column;gap:10px;margin-top:12px}
  .form-row label{font-size:14px;color:var(--muted);font-weight:600}
  .form-row input, .form-row select, .form-row textarea{padding:12px;border-radius:12px;border:1px solid #e6eef0;font-size:15px}
  .actions{display:flex;gap:12px;margin-top:18px}

  /* primary buttons */
  .btn{padding:14px 16px;border-radius:12px;border:0;cursor:pointer;font-weight:800;font-size:15px}
  .btn-primary{background:linear-gradient(180deg,var(--accent),var(--accent-700));color:white;box-shadow:0 12px 26px rgba(255,0,0,0.08)}
  .btn-ghost{background:white;border:1px solid rgba(7,16,34,0.06);color:var(--accent)}

  /* overlays / modals */
  .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(6,10,20,0.5);z-index:140;padding:24px}
  .overlay.active{display:flex}
  .modal{width:100%;max-width:720px;background:var(--card);border-radius:14px;padding:22px;box-shadow:var(--shadow-lg);transform-origin:center}
  .modal h3{margin:0 0 10px 0;font-size:20px}
  .modal .muted{color:var(--muted);font-size:15px}

  .spinner{width:66px;height:66px;border-radius:999px;border:8px solid rgba(0,0,0,0.06);border-top-color:var(--accent);animation:spin 1s linear infinite; margin:0 auto}
  @keyframes spin{to{transform:rotate(360deg)}}

  /* confirmation big check */
  .success-hero{display:flex;flex-direction:column;align-items:center;gap:14px;padding:28px}
  .check{width:110px;height:110px;border-radius:999px;background:linear-gradient(180deg,#fff6f6,#ffffff);display:flex;align-items:center;justify-content:center;border:6px solid rgba(176,0,0,0.12)}
  .check svg{width:64px;height:64px}
  .success-title{font-size:22px;font-weight:800;color:#b00000}
  .success-sub{font-size:16px;color:var(--muted)}

  /* small helpers */
  .muted{color:var(--muted)}
  .center{display:flex;justify-content:center;align-items:center}
  .link-like{background:transparent;border:0;color:var(--accent);cursor:pointer;font-weight:700}

  .hidden{display:none}
  .favorites-list{margin-top:10px;display:flex;flex-direction:column;gap:8px}
  .fav-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px solid rgba(7,16,34,0.04)}
</style>
</head>
<body>
<div class="app" id="app">

  <!-- TOPBAR -->
  <div class="topbar" role="banner">
    <div class="brand" aria-hidden="false">
      <div class="logo" title="SPARX">
        <svg width="34" height="34" viewBox="0 0 24 24" fill="none" aria-hidden="true" xmlns="http://www.w3.org/2000/svg"><rect x="2" y="2" width="20" height="20" rx="5" fill="white"/><path d="M9 8v8M9 13h6a3 3 0 0 0 0-6H9" stroke="#FF0000" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div>
        <div class="title">SPARX</div>
        <div class="brand-sub">A Smart Parking and Road eXperience System</div>
      </div>
    </div>

    <div class="spacer"></div>

    <div style="display:flex;gap:12px;align-items:center">
      <div class="clock" id="liveClock" aria-live="polite">--:--:--</div>
      <button id="btnLogout" class="link-like" title="Logout">Logout</button>
      <button id="btnProfile" class="btn-ghost" title="Profile">Profile</button>
      <button id="btnOpenLogin" class="btn-ghost" title="Login / Switch user">Login</button>
    </div>
  </div>

  <!-- MAIN SCREENS -->
  <div class="screens">

    <!-- LEFT: main flow screens -->
    <div>

      <!-- 1) Login Screen -->
      <section id="screen-login" class="panel screen active" aria-labelledby="loginTitle">
        <div class="panel-title">
          <h3 id="loginTitle">Sign In to Continue</h3>
          <div class="small-muted">Secure Access</div>
        </div>

        <form id="loginForm" onsubmit="return false">
          <div class="form-row">
            <label for="email">Email</label>
            <input id="email" type="email" placeholder="hello@gmail.com" required />
          </div>
          <div class="form-row">
            <label for="password">Password</label>
            <input id="password" type="password" placeholder="••••••••" required />
          </div>

          <div class="actions">
            <button id="loginBtn" class="btn btn-primary">Login</button>
            <button id="guestBtn" class="btn btn-ghost">Continue as Guest</button>
          </div>
        </form>
      </section>

      <!-- 2) Choose Parking Spot -->
      <section id="screen-choose" class="panel screen" aria-labelledby="chooseTitle">
        <div class="panel-title">
          <h3 id="chooseTitle">Choose a Parking Spot</h3>
          <div class="small-muted" id="chooseSubtitle">Select a Spot to Reserve</div>
        </div>

        <div class="searchbar">
          <input id="searchInput" placeholder="Search by name or campus" />
          <button id="searchBtn" class="btn-search" title="Search">Search</button>
          <button id="filterBtn" class="btn btn-ghost" title="Filter">Filter</button>
        </div>

        <div style="display:flex;gap:12px;align-items:flex-start">
          <div style="flex:1">
            <div id="spotsGrid" class="spots-grid" role="list" aria-live="polite">
              <!-- spots injected by JS -->
            </div>
          </div>

          <div style="width:320px;margin-left:12px">
            <div class="panel card-compact">
              <div style="font-weight:800">Map</div>
              <div id="map" aria-hidden="false"></div>
            </div>

            <div class="panel card-compact" style="margin-top:12px">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:800">Favorites</div>
                <button id="clearFavs" class="btn btn-ghost">Clear</button>
              </div>
              <div id="favoritesList" class="favorites-list"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- 3) Reservation Screen -->
      <section id="screen-reserve" class="panel screen" aria-labelledby="reserveTitle">
        <div class="panel-title">
          <h3 id="reserveTitle">Reserve Spot</h3>
          <div class="small-muted" id="reserveSpotName">...</div>
        </div>

        <form id="reserveForm" onsubmit="return false">
          <div class="form-row">
            <label for="rname">Your Name</label>
            <input id="rname" placeholder="Full name" required />
          </div>

          <div class="form-row">
            <label for="rvehicle">Vehicle / Plate</label>
            <input id="rvehicle" placeholder="e.g. Toyota Vios - ABC 1234" required />
          </div>

          <div class="form-row">
            <label for="rdate">Date</label>
            <input id="rdate" type="date" required />
          </div>

          <div class="actions">
            <button id="confirmReserveBtn" class="btn btn-primary">Reserve</button>
            <button id="backToChoose" class="btn btn-ghost">Back</button>
          </div>
        </form>
      </section>

      <!-- 4) Confirmation Screen (big check) -->
      <section id="screen-confirm" class="panel screen" aria-labelledby="confirmTitle">
        <div class="panel-title">
          <h3 id="confirmTitle">Reservation Confirmed</h3>
          <div class="small-muted">Keep this reference for management</div>
        </div>

        <div class="card-compact success-hero">
          <div class="check" aria-hidden="true">
            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 6L9 17l-5-5" stroke="#b00000" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          </div>
          <div class="success-title">You're all set!</div>
          <div class="success-sub" id="successMessage">Reservation completed successfully.</div>

          <div style="width:100%;margin-top:8px;background:var(--card);padding:14px;border-radius:10px;border:1px solid rgba(7,16,34,0.04)">
            <div style="font-weight:800;font-size:16px" id="confSpot">...</div>
            <div class="muted" id="confCampus">...</div>
            <div style="margin-top:10px" class="muted">Reserved for</div>
            <div style="font-weight:700" id="confName">...</div>
            <div style="margin-top:8px" class="muted">Date</div>
            <div style="font-weight:700" id="confDate">...</div>
            <div style="margin-top:8px" class="muted">Reservation Reference</div>
            <div style="font-weight:700" id="confRef">...</div>
          </div>

          <div style="display:flex;gap:12px;margin-top:12px">
            <button id="btnCancelRes" class="btn btn-ghost">Cancel reservation</button>
            <button id="btnDone" class="btn btn-primary">Done</button>
          </div>
        </div>
      </section>

      <!-- 5) Cancelation / Management -->
      <section id="screen-manage" class="panel screen" aria-labelledby="manageTitle">
        <div class="panel-title">
          <h3 id="manageTitle">Manage Reservations</h3>
          <div class="small-muted">View or Cancel Active Reservations</div>
        </div>

        <div id="myReservations">
          <!-- dynamic reservation cards -->
        </div>
      </section>

    </div>

    <!-- RIGHT: preview / account -->
    <aside class="preview">
      <div class="card-compact panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="avatar" aria-hidden="true">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none"><path d="M12 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8z" fill="#FF0000"/><path d="M3 20c0-3.3 3.6-6 9-6s9 2.7 9 6" fill="#ffecec"/></svg>
            </div>
            <div>
              <div id="acctName" class="name">Guest</div>
              <div class="small-muted" id="acctEmail">Not Signed In</div>
            </div>
          </div>

          <div>
            <button id="manageBtn" class="btn btn-ghost">My Reservations</button>
          </div>
        </div>
      </div>

      <div class="card-compact panel">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div>
            <div style="font-weight:800;font-size:18px" id="spotCount">0 Spots</div>
            <div class="small-muted">Available Spaces Now</div>
          </div>
          <div style="display:flex;flex-direction:column;gap:10px">
            <button id="refreshBtn" class="btn btn-ghost">Refresh</button>
            <button id="helpBtn" class="btn btn-ghost">Help</button>
          </div>
        </div>
      </div>

      <div id="quickActions" class="card-compact panel center">
        <div>
          <div style="font-weight:800;font-size:18px">Quick Actions</div>
          <div style="display:flex;gap:12px;margin-top:12px">
            <button id="quickReserve" class="btn btn-primary">Reserve Spot</button>
            <button id="quickLogin" class="btn btn-ghost">Login</button>
          </div>
        </div>
      </div>
    </aside>

  </div>
</div>

<!-- Overlays -->
<div id="overlay" class="overlay" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal center" role="document" id="overlayContent" aria-live="polite">
    <!-- dynamic content -->
  </div>
</div>

<template id="confirmTemplate">
  <div>
    <h3 id="ovTitle">Processing</h3>
    <p class="muted" id="ovMessage">Please wait...</p>
    <div style="margin-top:18px" class="center">
      <div class="spinner" aria-hidden="true"></div>
    </div>
  </div>
</template>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-o9N1j6k0b38H8FfKk3V4sKjGkTrkD6lZ3Kz3y3f6K6k="
  crossorigin=""></script>

<script>
/* ---------- Demo data with coordinates ---------- */
const spotsData = [
  { id:1, title:'Parking Spot 1A (AEB Front)', campus:'BSU - Alangilan', addr:'Neptune Street, GCH', reserved:false, lat:13.755, lng:121.052 },
  { id:2, title:'Parking Spot 2A (AEB Front)', campus:'BSU - Alangilan', addr:'Neptune Street, GCH', reserved:false, lat:13.7555, lng:121.0525 },
  { id:3, title:'Lot A', campus:'North Lot', addr:'Mercury Street, GCH', reserved:false, lat:13.754, lng:121.051 },
  { id:4, title:'Lot B', campus:'South Lot', addr:'Mars Street, GCH', reserved:false, lat:13.753, lng:121.053 },
  { id:5, title:'Spot 1S (Beside Steer Hub)', campus:'BSU - Alangilan', addr:'Neptune Street, GCH', reserved:false, lat:13.756, lng:121.054 }
];

/* ---------- favorites persistence ---------- */
const FAVORITES_KEY = 'sparx_favs';
function loadFavorites(){ try { return JSON.parse(localStorage.getItem(FAVORITES_KEY) || '[]') } catch(e){ return [] } }
function saveFavorites(arr){ localStorage.setItem(FAVORITES_KEY, JSON.stringify(arr)) }
let favorites = loadFavorites();

/* ---------- App state ---------- */
const state = {
  user: null, // {name,email}
  selectedSpot: null,
  reservations: [] // {id, spotId, name, vehicle, date, ref}
};

/* ---------- Leaflet map ---------- */
let map, markers = {};
function initMap(){
  try {
    map = L.map('map', { zoomControl: true }).setView([13.755, 121.052], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19,
      attribution: '© OpenStreetMap'
    }).addTo(map);

    // add markers
    spotsData.forEach(s => {
      if(s.lat && s.lng){
        const m = L.marker([s.lat, s.lng]).addTo(map).bindPopup(`<strong>${escapeHtml(s.title)}</strong><br>${escapeHtml(s.campus)}`);
        m.on('click', () => {
          selectSpot(s.id);
          // open popup
          m.openPopup();
        });
        markers[s.id] = m;
      }
    });
  } catch(e){
    console.warn('Map init failed', e);
    document.getElementById('map').innerHTML = '<div class="muted">Map failed to load (check internet / CDN)</div>';
  }
}

/* ---------- Helpers: navigation / UI ---------- */
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  const el = document.getElementById(id);
  if(el) el.classList.add('active');
  history.replaceState(null, '', '#' + id);
}

function openOverlay(htmlContent){
  const overlay = document.getElementById('overlay');
  const content = document.getElementById('overlayContent');
  content.innerHTML = '';
  content.appendChild(htmlContent);
  overlay.classList.add('active');
  overlay.setAttribute('aria-hidden','false');
}

function closeOverlay(){
  const overlay = document.getElementById('overlay');
  overlay.classList.remove('active');
  overlay.setAttribute('aria-hidden','true');
}

/* ---------- Escape HTML (tiny helper) ---------- */
function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

/* ---------- Render spots list (no dates on cards) ---------- */
const spotsGrid = document.getElementById('spotsGrid');
const spotCountEl = document.getElementById('spotCount');

function renderSpots(filter=''){
  spotsGrid.innerHTML = '';
  const list = spotsData.filter(s => (s.title + ' ' + s.campus + ' ' + s.addr).toLowerCase().includes(filter.toLowerCase()));
  list.forEach(s => {
    const favActive = favorites.includes(s.id);
    const node = document.createElement('div');
    node.className = 'spot';
    node.tabIndex = 0;
    node.innerHTML = `
      <div class="icon" aria-hidden="true">
        <svg width="36" height="36" viewBox="0 0 24 24" fill="none"><path d="M9 8v8" stroke="#FF0000" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/><path d="M9 13h6a3 3 0 0 0 0-6H9" stroke="#FF0000" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </div>
      <div class="meta">
        <h4>${escapeHtml(s.title)}</h4>
        <p>${escapeHtml(s.campus)} · ${escapeHtml(s.addr)}</p>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
        <button class="fav-btn ${favActive ? 'active' : ''}" data-id="${s.id}" title="Favorite" aria-label="favorite">${favActive ? '★' : '☆'}</button>
        <div class="status ${s.reserved ? 'status-reserved' : 'status-available'}">${s.reserved ? 'Reserved' : 'Available'}</div>
      </div>
    `;
    node.addEventListener('click', (e) => {
      // avoid selecting when clicking fav button
      if(e.target.closest('.fav-btn')) return;
      selectSpot(s.id);
    });
    node.addEventListener('keydown', (e) => { if(e.key === 'Enter') selectSpot(s.id) });
    spotsGrid.appendChild(node);

    // fav toggle handler
    node.querySelectorAll('.fav-btn').forEach(b => {
      b.addEventListener('click', (ev) => {
        ev.stopPropagation();
        const id = Number(b.dataset.id);
        toggleFav(id);
        b.classList.toggle('active');
        b.textContent = favorites.includes(id) ? '★' : '☆';
        renderFavorites();
      });
    });
  });

  const availableCount = spotsData.filter(s => !s.reserved).length;
  spotCountEl.textContent = `${availableCount} available`;

  // update markers highlight
  Object.keys(markers).forEach(id => {
    const mid = Number(id);
    const marker = markers[mid];
    const spot = spotsData.find(s => s.id === mid);
    if(!marker || !spot) return;
    // change icon color by reserved
    const el = marker._icon;
    if(el){
      el.style.filter = spot.reserved ? 'grayscale(40%)' : 'none';
      el.style.opacity = favorites.includes(mid) ? '1' : '0.9';
      el.style.transform = favorites.includes(mid) ? 'scale(1.1)' : '';
    }
  });
}

/* ---------- Favorites ---------- */
function toggleFav(id){
  if(favorites.includes(id)){
    favorites = favorites.filter(x => x !== id);
  } else {
    favorites.push(id);
  }
  saveFavorites(favorites);
}

function renderFavorites(){
  const favList = document.getElementById('favoritesList');
  favList.innerHTML = '';
  if(favorites.length === 0){
    favList.innerHTML = `<div class="muted">No favorites yet. Click the ★ on a spot to add.</div>`;
    return;
  }
  favorites.forEach(fid => {
    const s = spotsData.find(x => x.id === fid);
    if(!s) return;
    const item = document.createElement('div');
    item.className = 'fav-item';
    item.innerHTML = `<div>${escapeHtml(s.title)}</div><div style="display:flex;gap:8px"><button class="btn btn-ghost btnViewFav" data-id="${fid}">View</button><button class="btn btn-ghost btnRemoveFav" data-id="${fid}">Remove</button></div>`;
    favList.appendChild(item);
  });
  favList.querySelectorAll('.btnViewFav').forEach(b => {
    b.addEventListener('click', (e) => {
      const id = Number(e.currentTarget.dataset.id);
      const s = spotsData.find(x => x.id === id);
      if(!s) return;
      // center map
      if(markers[id]) map.setView(markers[id].getLatLng(), 17, { animate:true });
      selectSpot(id);
    });
  });
  favList.querySelectorAll('.btnRemoveFav').forEach(b => {
    b.addEventListener('click', (e) => {
      const id = Number(e.currentTarget.dataset.id);
      favorites = favorites.filter(x => x !== id);
      saveFavorites(favorites);
      renderFavorites();
      renderSpots(document.getElementById('searchInput').value);
    });
  });
}

/* ---------- Selection flow ---------- */
function selectSpot(id){
  const spot = spotsData.find(x => x.id === id);
  if(!spot) return;
  state.selectedSpot = spot;
  document.getElementById('reserveSpotName').textContent = `${spot.title} — ${spot.campus}`;
  // center map on selected
  if(markers[id]) {
    map.setView(markers[id].getLatLng(), 17, { animate:true });
    markers[id].openPopup();
  }
  showScreen('screen-reserve');
}

/* ---------- Live clock (header) ---------- */
function updateClock(){
  const el = document.getElementById('liveClock');
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,'0');
  const mm = String(now.getMinutes()).padStart(2,'0');
  const ss = String(now.getSeconds()).padStart(2,'0');
  el.textContent = `${hh}:${mm}:${ss}`;
}
setInterval(updateClock, 1000);
updateClock();

/* ---------- Login flow ---------- */
const loginBtn = document.getElementById('loginBtn');
const guestBtn = document.getElementById('guestBtn');

function applyUser(user){
  state.user = user;
  document.getElementById('acctName').textContent = user ? user.name : 'Guest';
  document.getElementById('acctEmail').textContent = user ? user.email : 'Not Signed In';
  renderQuickActions();
  if(user) showScreen('screen-choose');
}

loginBtn.addEventListener('click', (e) => {
  e.preventDefault();
  const email = document.getElementById('email').value.trim();
  const pw = document.getElementById('password').value.trim();
  if(!email || !pw){ alert('Enter email and password (demo).'); return; }
  const tpl = document.getElementById('confirmTemplate');
  const clone = tpl.content.cloneNode(true);
  clone.querySelector('#ovTitle').textContent = 'Signing in';
  clone.querySelector('#ovMessage').textContent = 'Authenticating...';
  openOverlay(clone);
  setTimeout(() => {
    closeOverlay();
    applyUser({name: email.split('@')[0], email});
  }, 900);
});

guestBtn.addEventListener('click', (e) => {
  e.preventDefault();
  applyUser({name:'Guest', email:'guest@local'});
});

/* ---------- Render quick actions (hide when logged in as real user) ---------- */
function renderQuickActions(){
  const quick = document.getElementById('quickActions');
  if(state.user && state.user.email !== 'guest@local'){
    quick.classList.add('hidden');
  } else {
    quick.classList.remove('hidden');
  }
}

/* ---------- Quick actions handlers ---------- */
document.getElementById('btnOpenLogin').addEventListener('click', () => showScreen('screen-login'));
document.getElementById('quickLogin').addEventListener('click', () => showScreen('screen-login'));
document.getElementById('quickReserve').addEventListener('click', () => showScreen('screen-choose'));

/* ---------- Reserve flow ---------- */
document.getElementById('backToChoose').addEventListener('click', () => showScreen('screen-choose'));

document.getElementById('confirmReserveBtn').addEventListener('click', (e) => {
  e.preventDefault();
  const name = document.getElementById('rname').value.trim();
  const vehicle = document.getElementById('rvehicle').value.trim();
  const date = document.getElementById('rdate').value;
  if(!state.selectedSpot) { alert('No spot selected.'); showScreen('screen-choose'); return; }
  if(!name || !vehicle || !date){ alert('Please fill the reservation form.'); return; }

  const tpl = document.getElementById('confirmTemplate');
  const clone = tpl.content.cloneNode(true);
  clone.querySelector('#ovTitle').textContent = 'Reserving spot';
  clone.querySelector('#ovMessage').textContent = 'Hold on while we confirm your slot...';
  openOverlay(clone);

  setTimeout(() => {
    const ref = 'R-' + Math.random().toString(36).substring(2,9).toUpperCase();
    const res = { id: Date.now(), spotId: state.selectedSpot.id, name, vehicle, date, ref };
    state.reservations.push(res);
    const spot = spotsData.find(s => s.id === state.selectedSpot.id);
    if(spot) spot.reserved = true;
    renderSpots(document.getElementById('searchInput').value);
    document.getElementById('confSpot').textContent = state.selectedSpot.title;
    document.getElementById('confCampus').textContent = state.selectedSpot.campus + ' · ' + state.selectedSpot.addr;
    document.getElementById('confName').textContent = res.name + ' · ' + res.vehicle;
    document.getElementById('confDate').textContent = new Date(res.date).toLocaleDateString();
    document.getElementById('confRef').textContent = res.ref;
    closeOverlay();
    document.getElementById('successMessage').textContent = `Reservation for ${res.date} confirmed.`;
    showScreen('screen-confirm');
    renderMyReservations();
  }, 1100);
});

/* ---------- Confirmation actions ---------- */
document.getElementById('btnDone').addEventListener('click', () => showScreen('screen-choose'));

document.getElementById('btnCancelRes').addEventListener('click', () => {
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <h3>Cancel reservation?</h3>
    <p class="muted">Are you sure you want to cancel this reservation? This action cannot be undone in demo mode.</p>
    <div style="display:flex;gap:12px;margin-top:18px;justify-content:center">
      <button id="confirmCancel" class="btn btn-ghost">No, keep it</button>
      <button id="confirmCancelYes" class="btn btn-primary">Yes, cancel</button>
    </div>
  `;
  openOverlay(wrap);
  document.getElementById('confirmCancel').addEventListener('click', closeOverlay);
  document.getElementById('confirmCancelYes').addEventListener('click', () => {
    const ref = document.getElementById('confRef').textContent;
    cancelReservationByRef(ref);
    closeOverlay();
    showScreen('screen-choose');
  });
});

/* ---------- Cancel / Manage list ---------- */
const myReservationsEl = document.getElementById('myReservations');
function renderMyReservations(){
  myReservationsEl.innerHTML = '';
  if(state.reservations.length === 0){ myReservationsEl.innerHTML = `<div class="card-compact"><div class="muted">No active reservations.</div></div>`; return; }
  state.reservations.slice().reverse().forEach(r => {
    const spot = spotsData.find(s => s.id === r.spotId) || {};
    const card = document.createElement('div');
    card.className = 'card-compact';
    card.style.marginBottom = '12px';
    card.innerHTML = `
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <div style="font-weight:800">${escapeHtml(spot.title || 'Unknown')}</div>
          <div class="muted">${escapeHtml(r.name)} · ${new Date(r.date).toLocaleDateString()}</div>
          <div class="muted small" style="margin-top:8px">Ref: ${escapeHtml(r.ref)}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:10px">
          <button class="btn btn-ghost btnView" data-ref="${r.ref}">View</button>
          <button class="btn btn-primary btnCancel" data-ref="${r.ref}">Cancel</button>
        </div>
      </div>
    `;
    myReservationsEl.appendChild(card);
  });

  myReservationsEl.querySelectorAll('.btnCancel').forEach(b => {
    b.addEventListener('click', (e) => {
      const ref = e.currentTarget.dataset.ref;
      const wrap = document.createElement('div');
      wrap.innerHTML = `
        <h3>Cancel reservation?</h3>
        <p class="muted">Cancel reservation <strong>${ref}</strong>?</p>
        <div style="display:flex;gap:12px;margin-top:18px;justify-content:center">
          <button id="cancelNo" class="btn btn-ghost">No</button>
          <button id="cancelYes" class="btn btn-primary">Yes, cancel</button>
        </div>
      `;
      openOverlay(wrap);
      document.getElementById('cancelNo').addEventListener('click', closeOverlay);
      document.getElementById('cancelYes').addEventListener('click', () => { cancelReservationByRef(ref); closeOverlay(); });
    });
  });

  myReservationsEl.querySelectorAll('.btnView').forEach(b => {
    b.addEventListener('click', (e) => {
      const ref = e.currentTarget.dataset.ref;
      const r = state.reservations.find(x => x.ref === ref);
      if(!r) return;
      const spot = spotsData.find(s => s.id === r.spotId) || {};
      document.getElementById('confSpot').textContent = spot.title || 'Unknown';
      document.getElementById('confCampus').textContent = (spot.campus || '') + ' · ' + (spot.addr || '');
      document.getElementById('confName').textContent = r.name + ' · ' + r.vehicle;
      document.getElementById('confDate').textContent = new Date(r.date).toLocaleDateString();
      document.getElementById('confRef').textContent = r.ref;
      showScreen('screen-confirm');
    });
  });
}

function cancelReservationByRef(ref){
  const idx = state.reservations.findIndex(r => r.ref === ref);
  if(idx === -1) return;
  const r = state.reservations[idx];
  state.reservations.splice(idx, 1);
  const spot = spotsData.find(s => s.id === r.spotId);
  if(spot) spot.reserved = false;
  renderSpots(document.getElementById('searchInput').value);
  renderMyReservations();
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <h3>Cancelled</h3>
    <p class="muted">Reservation ${ref} has been cancelled.</p>
    <div style="display:flex;justify-content:center;margin-top:18px">
      <button id="okDone" class="btn btn-primary">OK</button>
    </div>
  `;
  openOverlay(wrap);
  document.getElementById('okDone').addEventListener('click', closeOverlay);
}

/* ---------- Logout (modal confirm) ---------- */
document.getElementById('btnLogout').addEventListener('click', () => {
  const wrap = document.createElement('div');
  wrap.innerHTML = `
    <h3>Log out</h3>
    <p class="muted">Are you sure you want to log out?</p>
    <div style="display:flex;gap:12px;margin-top:18px;justify-content:center">
      <button id="logoutNo" class="btn btn-ghost">No</button>
      <button id="logoutYes" class="btn btn-primary">Yes, log out</button>
    </div>
  `;
  openOverlay(wrap);
  document.getElementById('logoutNo').addEventListener('click', closeOverlay);
  document.getElementById('logoutYes').addEventListener('click', () => {
    closeOverlay();
    const tpl = document.getElementById('confirmTemplate');
    const clone = tpl.content.cloneNode(true);
    clone.querySelector('#ovTitle').textContent = 'Signing out';
    clone.querySelector('#ovMessage').textContent = 'Closing your session...';
    openOverlay(clone);
    setTimeout(() => { closeOverlay(); state.user = null; document.getElementById('acctName').textContent = 'Guest'; document.getElementById('acctEmail').textContent = 'Not Signed In'; renderQuickActions(); showScreen('screen-login'); }, 900);
  });
});

/* ---------- Misc ---------- */
document.getElementById('refreshBtn').addEventListener('click', () => { renderSpots(document.getElementById('searchInput').value); renderMyReservations(); });
document.getElementById('helpBtn').addEventListener('click', () => { const wrap = document.createElement('div'); wrap.innerHTML = `<h3>Help & Support</h3><p class="muted">This is a demo SPA UI. To wire it to a backend you would POST the reservation and manage authentication server-side.</p><div style="display:flex;justify-content:center;margin-top:18px"><button id="closeHelp" class="btn btn-primary">Close</button></div>`; openOverlay(wrap); document.getElementById('closeHelp').addEventListener('click', closeOverlay); });
document.getElementById('manageBtn').addEventListener('click', () => { renderMyReservations(); showScreen('screen-manage'); });

/* search input + button */
document.getElementById('searchInput').addEventListener('input', (e) => renderSpots(e.target.value));
document.getElementById('searchBtn').addEventListener('click', () => {
  const q = document.getElementById('searchInput').value;
  renderSpots(q);
  // optional: zoom to first match
  const first = spotsData.find(s => (s.title + ' ' + s.campus + ' ' + s.addr).toLowerCase().includes(q.toLowerCase()));
  if(first && markers[first.id]) map.setView(markers[first.id].getLatLng(), 17);
});

/* clear favorites */
document.getElementById('clearFavs').addEventListener('click', () => {
  if(!confirm('Clear all favorites?')) return;
  favorites = [];
  saveFavorites(favorites);
  renderFavorites();
  renderSpots(document.getElementById('searchInput').value);
});

/* ---------- Init ---------- */
function init(){
  initMap();
  renderSpots();
  renderMyReservations();
  renderQuickActions();
  renderFavorites();
}

/* ---------- Utility: keyboard escape overlay close ---------- */
document.addEventListener('keydown', (e) => { if(e.key === 'Escape') { closeOverlay(); } });

window.addEventListener('load', init);
</script>
</body>
</html>
